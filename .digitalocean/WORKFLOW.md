# Complete Deployment Workflow

## Overview

This document explains how the deployment system works and how to use it.

## File Structure

```
.digitalocean/
├── welcome.html                  # Welcome page template (version controlled)
├── nginx.conf                    # Nginx config template (reference only)
├── droplet-setup.sh             # Main setup script (idempotent)
├── update-nginx-welcome.sh      # Quick update script
├── APPLY_NOW.md                 # Quick start guide
├── QUICK_UPDATE.md              # Update guide
├── SUMMARY.md                   # Architecture summary
└── WORKFLOW.md                  # This file

Deployed Files (on droplet):
/var/www/asterdex/index.html     # Copied from .digitalocean/welcome.html
/etc/nginx/sites-available/asterdex-api  # Generated by scripts
```

## Workflow 1: Initial Deployment

### Step 1: Prepare Repository
```bash
# On your local machine
git add .
git commit -m "Add deployment configuration"
git push origin main
```

### Step 2: Create Droplet
1. Go to DigitalOcean
2. Create Ubuntu 22.04 droplet
3. Note the IP address

### Step 3: Run Setup Script
```bash
# SSH into droplet
ssh root@YOUR_DROPLET_IP

# Clone repository
git clone YOUR_REPO_URL /opt/asterdex-trading-api
cd /opt/asterdex-trading-api

# Run setup (will prompt for credentials and domain)
bash .digitalocean/droplet-setup.sh
```

### Step 4: Verify
```bash
# Test welcome page
curl http://YOUR_DROPLET_IP/

# Test API
curl http://YOUR_DROPLET_IP/health
curl http://YOUR_DROPLET_IP/docs
```

## Workflow 2: Update Welcome Page

### Step 1: Edit Locally
```bash
# On your local machine
nano .digitalocean/welcome.html
# Make your changes
```

### Step 2: Commit and Push
```bash
git add .digitalocean/welcome.html
git commit -m "Update welcome page"
git push origin main
```

### Step 3: Deploy to Droplet
```bash
# SSH into droplet
ssh root@YOUR_DROPLET_IP
cd /opt/asterdex-trading-api

# Pull changes
git pull

# Copy updated welcome page
cp .digitalocean/welcome.html /var/www/asterdex/index.html

# No nginx reload needed - it's a static file!
```

### Step 4: Verify
```bash
# Test in browser or with curl
curl http://YOUR_DROPLET_IP/
```

## Workflow 3: Update Nginx Configuration

### Step 1: Edit Script
```bash
# On your local machine
# Edit the nginx config section in:
nano .digitalocean/droplet-setup.sh
# or
nano .digitalocean/update-nginx-welcome.sh
```

### Step 2: Commit and Push
```bash
git add .digitalocean/
git commit -m "Update nginx configuration"
git push origin main
```

### Step 3: Deploy to Droplet
```bash
# SSH into droplet
ssh root@YOUR_DROPLET_IP
cd /opt/asterdex-trading-api

# Pull changes
git pull

# Run update script
bash .digitalocean/update-nginx-welcome.sh
```

### Step 4: Verify
```bash
# Check nginx config
sudo nginx -t

# Test endpoints
curl http://YOUR_DROPLET_IP/
curl http://YOUR_DROPLET_IP/health
```

## Workflow 4: Update Application Code

### Step 1: Make Changes
```bash
# On your local machine
# Edit your Python code
nano src/app.py
```

### Step 2: Commit and Push
```bash
git add .
git commit -m "Update application"
git push origin main
```

### Step 3: Deploy to Droplet
```bash
# SSH into droplet
ssh root@YOUR_DROPLET_IP
cd /opt/asterdex-trading-api

# Pull changes
git pull

# Rebuild and restart containers
docker compose down
docker compose build
docker compose up -d

# Check logs
docker compose logs -f
```

## Workflow 5: Full System Update

If you want to update everything (welcome page, nginx, and app):

```bash
# SSH into droplet
ssh root@YOUR_DROPLET_IP
cd /opt/asterdex-trading-api

# Pull all changes
git pull

# Re-run setup script (idempotent - safe to run)
bash .digitalocean/droplet-setup.sh

# Rebuild app if code changed
docker compose up -d --build
```

## How Scripts Work

### droplet-setup.sh (Idempotent)

```bash
# What it does:
1. Checks if Docker installed → Install if missing
2. Checks if repo cloned → Clone or pull
3. Checks if .env exists → Create if missing
4. Starts Docker containers
5. Copies .digitalocean/welcome.html → /var/www/asterdex/index.html
6. Creates nginx config with your domain
7. Reloads nginx

# Safe to run multiple times:
- Won't reinstall packages
- Won't overwrite .env
- Will update welcome page
- Will update nginx config
```

### update-nginx-welcome.sh (Quick Update)

```bash
# What it does:
1. Copies .digitalocean/welcome.html → /var/www/asterdex/index.html
2. Reads saved domain from /etc/nginx/.asterdex-domain
3. Creates nginx config
4. Reloads nginx

# Use when:
- You only changed welcome page or nginx config
- You don't want to touch Docker or .env
- You want a quick update
```

## Common Scenarios

### Scenario 1: Change Welcome Page Text
```bash
# Local
nano .digitalocean/welcome.html
git commit -am "Update welcome text"
git push

# Droplet
ssh root@YOUR_IP
cd /opt/asterdex-trading-api
git pull
cp .digitalocean/welcome.html /var/www/asterdex/index.html
```

### Scenario 2: Add New API Endpoint
```bash
# Local
nano src/api/new_endpoint.py
git commit -am "Add new endpoint"
git push

# Droplet
ssh root@YOUR_IP
cd /opt/asterdex-trading-api
git pull
docker compose up -d --build
```

### Scenario 3: Change Domain Name
```bash
# Droplet
ssh root@YOUR_IP
cd /opt/asterdex-trading-api

# Update saved domain
echo "newdomain.com" > /etc/nginx/.asterdex-domain

# Re-run update script
bash .digitalocean/update-nginx-welcome.sh
```

### Scenario 4: Fresh Start
```bash
# Droplet
ssh root@YOUR_IP
cd /opt/asterdex-trading-api

# Stop everything
docker compose down

# Backup .env
cp .env .env.backup

# Pull latest
git pull

# Re-run setup
bash .digitalocean/droplet-setup.sh

# Restore .env if needed
cp .env.backup .env
docker compose up -d
```

## Key Concepts

### 1. Version Control
- Welcome page is in git (`.digitalocean/welcome.html`)
- Scripts are in git
- Configuration is generated from scripts
- Only `.env` is not in git (contains secrets)

### 2. Idempotency
- Scripts check before installing
- Safe to run multiple times
- Won't break existing setup
- Updates to latest version

### 3. Separation of Concerns
- **Nginx**: Serves static welcome page, proxies API
- **FastAPI**: Handles API logic
- **Docker**: Runs FastAPI app
- **Git**: Version control for code and config

### 4. Update Strategy
- **Welcome page only**: Just copy file, no reload needed
- **Nginx config**: Run update script, nginx reloads
- **App code**: Rebuild Docker containers
- **Everything**: Re-run setup script

## Troubleshooting

### Welcome page not updating
```bash
# Check if file was copied
ls -la /var/www/asterdex/index.html

# Check file content
cat /var/www/asterdex/index.html

# Force copy
cp .digitalocean/welcome.html /var/www/asterdex/index.html

# Clear browser cache
# Ctrl+Shift+R or Cmd+Shift+R
```

### Nginx not serving welcome page
```bash
# Check nginx config
sudo nginx -t
sudo cat /etc/nginx/sites-available/asterdex-api

# Check if site is enabled
ls -la /etc/nginx/sites-enabled/

# Reload nginx
sudo systemctl reload nginx

# Check nginx logs
sudo tail -f /var/log/nginx/error.log
```

### API not working
```bash
# Check if app is running
docker compose ps

# Check app logs
docker compose logs -f

# Test app directly
curl http://localhost:8000/health

# Restart app
docker compose restart
```

## Best Practices

1. **Always test locally first** (if possible)
2. **Commit and push before deploying**
3. **Pull before making changes on droplet**
4. **Check logs after updates**
5. **Keep .env backed up**
6. **Test endpoints after updates**
7. **Use update script for quick changes**
8. **Use full setup for major changes**

## Quick Reference

```bash
# Update welcome page only
git pull && cp .digitalocean/welcome.html /var/www/asterdex/index.html

# Update nginx config
git pull && bash .digitalocean/update-nginx-welcome.sh

# Update app code
git pull && docker compose up -d --build

# Update everything
git pull && bash .digitalocean/droplet-setup.sh

# View logs
docker compose logs -f

# Restart app
docker compose restart

# Check nginx
sudo nginx -t
sudo systemctl status nginx

# Check app
curl http://localhost:8000/health
```
